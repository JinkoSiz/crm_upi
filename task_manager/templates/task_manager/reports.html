{% extends 'task_manager/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <form method="get" action="" class="form-inline reports-form" id="laborCostsProjectsForm">
            <div class="logs-form-wrapper">
                <div class="logs-form-input-wrapper">
                    <!-- <input type="date"> -->
                    <div class="datepicker-container">
                        <input type="text" class="date-input" placeholder="Select date" />
                        <div class="datepicker" hidden>
                          <div class="datepicker-header">
                            <button class="prev">
                                <svg xmlns="http://www.w3.org/2000/svg" width="7" height="12" viewBox="0 0 7 12" fill="none">
                                    <path d="M5.421 10.9965L0.771484 6.34702L5.421 1.69751" stroke="#202020" stroke-width="1.54984" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div>
                                <select class="month-input">
                                    <option>Январь</option>
                                    <option>Февраль</option>
                                    <option>Март</option>
                                    <option>Апрель</option>
                                    <option>Май</option>
                                    <option>Июнь</option>
                                    <option>Июль</option>
                                    <option>Август</option>
                                    <option>Сентябрь</option>
                                    <option>Октябрь</option>
                                    <option>Ноябрь</option>
                                    <option>Декабрь</option>
                                </select>
                              <input type="number" class="year-input" />
                            </div>
                  
                            <button class="next">
                                <svg xmlns="http://www.w3.org/2000/svg" width="7" height="12" viewBox="0 0 7 12" fill="none">
                                    <path d="M1.26953 10.9965L5.91904 6.34702L1.26953 1.69751" stroke="#202020" stroke-width="1.54984" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                          </div>
                  
                            <div class="days">
                                <span>вс</span>
                                <span>пн</span>
                                <span>вт</span>
                                <span>ср</span>
                                <span>чт</span>
                                <span>пт</span>
                                <span>сб</span>
                            </div>
                  
                          <div class="dates"></div>
                        </div>
                      </div>
                    <span>—</span>
                    <input type="date">
                </div>
                <select name="logs-timings" id="logsTimings">
                    <option value="1">1</option>
                    <option value="1">2</option>
                    <option value="1">3</option>
                </select>
                <button class="accept-btn" type="submit">Применить</button>
            </div>
        </form>
        <div id="laborCostsProjectsTable" class="table-wrapper only-bottom">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 170px">
                            <button class="sorter" >
                                <p>Объект</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 100px">
                            <button class="sorter" >
                                <p>Отдел</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 140px">
                            <button class="sorter" >
                                <p>Сотрудник</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 80px">
                            <button class="sorter" >
                                <p>Стадия</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th>
                            <button class="sorter" >
                                <p>ЗИС</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 70px">
                            <button class="sorter" >
                                <p>Марка</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 165px">
                            <button class="sorter" >
                                <p>Локальная задача</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 69px">
                            <button class="sorter" >
                                <p>Время</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for project_title, project_data in detailed_report_projects.items %}
                        {% for entry in project_data.entries %}
                            <tr>
                                <td>{{ entry.project.title }}</td>
                                <td>{{ entry.department.title }}</td>
                                <td>{{ entry.user.first_name }} {{ entry.user.last_name }}</td>
                                <td>{{ entry.stage }}</td>
                                <td>{{ entry.building.title }}</td>
                                <td>{{ entry.mark.title }}</td>
                                <td>{{ entry.task.title }}</td>
                                <td>{{ entry.time }}</td>
                            </tr>
                        {% endfor %}
                        <tr class="finish-tr">
                            <td colspan="7" class="text-left">Итого {{ project_title }}</td>
                            <td colspan="1" class="text-left">{{ project_data.total_time }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <form method="get" action="" class="form-inline reports-form" id="laborCostsSectionsForm">
            <div class="logs-form-wrapper">
                <div class="logs-form-input-wrapper">
                    <input type="date">
                    <span>—</span>
                    <input type="date">
                </div>
                <select name="logs-timings" id="logsTimings">
                    <option value="1">1</option>
                    <option value="1">2</option>
                    <option value="1">3</option>
                </select>
                <button class="accept-btn" type="submit">Применить</button>
            </div>
        </form>
        <div id="laborCostsSectionsTable" class="table-wrapper only-bottom">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 100px">
                            <button class="sorter" >
                                <p>Отдел</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 140px">
                            <button class="sorter" >
                                <p>Сотрудник</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 170px">
                            <button class="sorter" >
                                <p>Объект</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 80px">
                            <button class="sorter" >
                                <p>Стадия</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th>
                            <button class="sorter" >
                                <p>ЗИС</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 70px">
                            <button class="sorter" >
                                <p>Марка</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 165px">
                            <button class="sorter" >
                                <p>Локальная задача</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 69px">
                            <button class="sorter" >
                                <p>Время</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for department_title, department_data in detailed_report_departments.items %}
                        {% for entry in department_data.entries %}
                            <tr>
                                <td>{{ entry.department.title }}</td>
                                <td>{{ entry.user.first_name }} {{ entry.user.last_name }}</td>
                                <td>{{ entry.project.title }}</td>
                                <td>{{ entry.stage }}</td>
                                <td>{{ entry.building.title }}</td>
                                <td>{{ entry.mark.title }}</td>
                                <td>{{ entry.task.title }}</td>
                                <td>{{ entry.time }}</td>
                            </tr>
                        {% endfor %}
                        <tr class="finish-tr">
                            <td colspan="7" class="text-left">Итого {{ department_title }}</td>
                            <td colspan="1" class="text-left">{{ department_data.total_time }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    const datepicker = document.querySelector(".datepicker");
    const dateInput = document.querySelector(".date-input");
    const yearInput = datepicker.querySelector(".year-input");
    const monthInput = datepicker.querySelector(".month-input");
    const cancelBtn = datepicker.querySelector(".cancel");
    const applyBtn = datepicker.querySelector(".apply");
    const nextBtn = datepicker.querySelector(".next");
    const prevBtn = datepicker.querySelector(".prev");
    const dates = datepicker.querySelector(".dates");

    let selectedDate = new Date();
    let year = selectedDate.getFullYear();
    let month = selectedDate.getMonth();

    // show datepicker
    dateInput.addEventListener("click", (e) => {
        datepicker.hidden = false;
        e.preventDefault();
    });

    // hide datepicker

    document.addEventListener('click', (e) => {
        if(!e.target.closest('.datepicker') && !e.target.closest('.date-input') && datepicker.hidden == false) {
            datepicker.hidden = true;
        } 
    })
    // cancelBtn.addEventListener("click", (e) => {
    //     datepicker.hidden = true;
    //     e.preventDefault();
    // });

    // handle apply button click event
    const Apply = (e) => {
    // set the selected date to date input
        dateInput.value = selectedDate.toLocaleDateString("ru-RU", {
            weekday: 'short',
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
        });

    // hide datepicker
        datepicker.hidden = true;
        e.preventDefault();
    };

    // handle next month nav
    nextBtn.addEventListener("click", (e) => {
        if (month === 11) year++;
        month = (month + 1) % 12;
        displayDates();
        e.preventDefault();
    });

    // handle prev month nav
    prevBtn.addEventListener("click", (e) => {
        if (month === 0) year--;
        month = (month - 1 + 12) % 12;
        displayDates();
        e.preventDefault();
    });

    // handle month input change event
    monthInput.addEventListener("change", () => {
        month = monthInput.selectedIndex;
        displayDates();
    });

    // handle year input change event
    yearInput.addEventListener("change", () => {
        year = yearInput.value;
        displayDates();
    });

    const updateYearMonth = () => {
        monthInput.selectedIndex = month;
        yearInput.value = year;
    };

    const handleDateClick = (e) => {
        e.preventDefault();
        const button = e.target;

        // remove the 'selected' class from other buttons
        const selected = dates.querySelector(".selected");
        selected && selected.classList.remove("selected");

        // add the 'selected' class to current button
        button.classList.add("selected");

        // set the selected date
        selectedDate = new Date(year, month, parseInt(button.textContent));
    };

    // render the dates in the calendar interface
    const displayDates = () => {
    // update year & month whenever the dates are updated
        updateYearMonth();

        // clear the dates
        dates.innerHTML = "";

        //* display the last week of previous month

        // get the last date of previous month
        const lastOfPrevMonth = new Date(year, month, 0);

        for (let i = 0; i <= lastOfPrevMonth.getDay(); i++) {
            const text = lastOfPrevMonth.getDate() - lastOfPrevMonth.getDay() + i;
            const button = createButton(text, true, -1);
            dates.appendChild(button);
        }

        //* display the current month

        // get the last date of the month
        const lastOfMOnth = new Date(year, month + 1, 0);

        for (let i = 1; i <= lastOfMOnth.getDate(); i++) {
            const button = createButton(i, false);
            button.addEventListener("click", handleDateClick);
            button.addEventListener("dblclick", Apply)
            dates.appendChild(button);
        }

        //* display the first week of next month

        const firstOfNextMonth = new Date(year, month + 1, 1);

        for (let i = firstOfNextMonth.getDay(); i < 7; i++) {
            const text = firstOfNextMonth.getDate() - firstOfNextMonth.getDay() + i;

            const button = createButton(text, true, 1);
            dates.appendChild(button);
        }
    };

    const createButton = (text, isDisabled = false, type = 0) => {
        const currentDate = new Date();

        // determine the date to compare based on the button type
        let comparisonDate = new Date(year, month + type, text);

        // check if the current button is the date today
        const isToday =
              currentDate.getDate() === text &&
              currentDate.getFullYear() === year &&
              currentDate.getMonth() === month;

        // check if the current button is selected
        const selected = selectedDate.getTime() === comparisonDate.getTime();

        const button = document.createElement("button");
        button.textContent = text;
        button.disabled = isDisabled;
        button.classList.toggle("today", isToday && !isDisabled);
        button.classList.toggle("selected", selected);
        return button;
    };

    displayDates();

</script>

{% endblock %}
