{% extends 'task_manager/base.html' %}

{% block title %}
Projects List
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="col-2">
                        <button class="sorter">
                            <p>Название</p>
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                  <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                        </button>
                    </th>
                    <th class="col-3">
                        <button class="sorter">
                            <p>Статус</p>
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                  <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                        </button>
                    </th>
                    <th class="col-3">
                        <button class="sorter">
                            <p>Здания и сооружения</p>
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                  <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                        </button>
                    </th>
                    <th class="col-3">
                        <button class="sorter">
                            <p>Разделы</p>
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                  <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                        </button>
                    </th>
                    <th class="col-1">
                        <p>Действия</p>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr>
                    <td>{{ project.title }}</td>
                    <td>{{ project.status.title }}</td>
                    <td></td>
                    <td></td>
                    <td>
                        <!-- Кнопка для удаления проекта -->
                        <button class="btn btn-danger btn-sm delete-project-btn" data-id="{{ project.pk }}">Удалить</button>
                        <!-- New buttons -->
                        <div class="actions-button-wrapper">
                            <button class="edit" data-toggle="modal" data-target="#projectModal" data-id="{{ project.pk }}" data-title="{{ project.title }}" data-status="{{ project.status_id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
                                    <path d="M1.31128 14.1984C1.34932 13.8561 1.36833 13.685 1.42012 13.525C1.46606 13.3831 1.53098 13.2481 1.6131 13.1235C1.70566 12.9832 1.82742 12.8614 2.07094 12.6179L13.0031 1.68577C13.9174 0.77141 15.3999 0.771411 16.3143 1.68577C17.2286 2.60013 17.2286 4.0826 16.3142 4.99696L5.38213 15.9291C5.1386 16.1726 5.01684 16.2943 4.87648 16.3869C4.75194 16.469 4.61688 16.5339 4.47496 16.5799C4.315 16.6317 4.14385 16.6507 3.80157 16.6887L1 17L1.31128 14.1984Z" stroke="#16AEDC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="delete" data-toggle="modal" data-target="#deleteConfirmationModal" data-id="{{ project.pk }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="23" height="24" viewBox="0 0 23 24" fill="none">
                                    <path d="M15.2604 6.16667V5.45833C15.2604 4.46657 15.2604 3.97069 15.0674 3.59189C14.8976 3.25869 14.6267 2.98779 14.2935 2.81801C13.9147 2.625 13.4188 2.625 12.4271 2.625H11.0104C10.0187 2.625 9.52278 2.625 9.14398 2.81801C8.81077 2.98779 8.53987 3.25869 8.37009 3.59189C8.17708 3.97069 8.17708 4.46657 8.17708 5.45833V6.16667M9.94792 11.0365V15.4635M13.4896 11.0365V15.4635M3.75 6.16667H19.6875M17.9167 6.16667V16.0833C17.9167 17.571 17.9167 18.3148 17.6272 18.883C17.3725 19.3828 16.9661 19.7892 16.4663 20.0438C15.8981 20.3333 15.1543 20.3333 13.6667 20.3333H9.77083C8.28319 20.3333 7.53937 20.3333 6.97117 20.0438C6.47137 19.7892 6.06501 19.3828 5.81035 18.883C5.52083 18.3148 5.52083 17.571 5.52083 16.0833V6.16667" stroke="#A6A6A6" stroke-width="1.77083" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно для создания и редактирования проекта -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="projectForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="projectModalLabel">Создать/Редактировать проект</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="id_title">Название проекта</label>
                        <input type="text" name="title" class="form-control" id="id_title" placeholder="Введите название проекта">
                    </div>
                    <div class="form-group">
                        <label for="id_status">Статус</label>
                        <select name="status" class="form-control" id="id_status">
                            {% for status in project_status %}
                            <option value="{{ status.pk }}">{{ status.title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Раздел для добавления зданий в проект -->
                    <h4>Здания</h4>
                    <ul id="buildingList" class="list-group mb-2"></ul>
                    <input type="text" id="buildingTitleInput" placeholder="Название здания" class="form-control mb-2">
                    <button type="button" id="addBuildingBtn" class="btn btn-primary mb-2">Добавить здание</button>

                    <!-- Разделы -->
                    <h4>Разделы</h4>
                    <div class="form-group">
                        {% for section in sections %}
                        <div class="form-check">
                            <label class="form-check-label" for="{{ section.pk }}">
                                <input type="checkbox" class="form-check-input" id="{{ section.pk }}" name="sections" value="{{ section.pk }}">{{ section.title }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="36" viewBox="0 0 32 36" fill="none">
                          <path d="M22.6667 7.66667V6.33333C22.6667 4.46649 22.6667 3.53307 22.3034 2.82003C21.9838 2.19282 21.4738 1.68289 20.8466 1.36331C20.1336 1 19.2002 1 17.3333 1H14.6667C12.7998 1 11.8664 1 11.1534 1.36331C10.5262 1.68289 10.0162 2.19282 9.69664 2.82003C9.33333 3.53307 9.33333 4.46649 9.33333 6.33333V7.66667M12.6667 16.8333V25.1667M19.3333 16.8333V25.1667M1 7.66667H31M27.6667 7.66667V26.3333C27.6667 29.1336 27.6667 30.5337 27.1217 31.6033C26.6423 32.5441 25.8774 33.309 24.9366 33.7884C23.8671 34.3333 22.4669 34.3333 19.6667 34.3333H12.3333C9.53307 34.3333 8.13294 34.3333 7.06338 33.7884C6.12257 33.309 5.35767 32.5441 4.8783 31.6033C4.33333 30.5337 4.33333 29.1336 4.33333 26.3333V7.66667" stroke="#FF6D6D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="title-delete">Вы действительно хотите <br> удалить проект?</p>
            </div>
            <div class="modal-footer modal-footer-delete">
                <form id="deleteProjectForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentProjectId = null;
    const csrfToken = '{{ csrf_token }}';

    // Обработчик открытия модалки для создания/редактирования проекта
    $('#projectModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget); // Кнопка, вызвавшая модалку
        currentProjectId = button.data('id');  // Получаем id проекта, если редактируем

        if (currentProjectId) {
            // Редактирование проекта
            $.ajax({
                url: `/projects/${currentProjectId}/`,
                method: 'GET',
                success: function (data) {
                    $('#id_title').val(data.project.title);
                    $('#id_status').val(data.project.status);
                    $('#buildingList').empty();
                    data.buildings.forEach(function (building) {
                        $('#buildingList').append(
                            `<li class="list-group-item" id="building-${building.building__pk}">${building.building__title} 
                            <button class="btn btn-danger btn-sm delete-building-btn" data-id="${building.building__pk}">Удалить</button></li>`
                        );
                    });

                    // Отмечаем разделы как выбранные, если они уже связаны с проектом
                    data.sections.forEach(function (section) {
                        $(`#section${section.section__pk}`).prop('checked', true);
                    });
                }
            });
        } else {
            // Создание проекта
            $('#id_title').val('');
            $('#id_status').val('');
            $('#buildingList').empty();
            // Снимаем отметку со всех чекбоксов разделов
            $('input[name="sections"]').prop('checked', false);
        }
    });

    // Обработчик сохранения проекта
    $('#projectForm').on('submit', function (event) {
        event.preventDefault();
        
        const title = $('#id_title').val();
        const status = $('#id_status').val();
        
        // Собираем список зданий из списка в модалке
        let buildings = [];
        $('#buildingList li').each(function() {
            let buildingTitle = $(this).clone().children('button').remove().end().text().trim();
            if (buildingTitle) {
                buildings.push(buildingTitle);
            }
        });

        // Собираем выбранные разделы
        let sections = [];
        $('input[name="sections"]:checked').each(function() {
            sections.push($(this).val());
        });
        console.log(sections);
        
        // Используем FormData для отправки данных
        let formData = new FormData();
        formData.append('title', title);
        formData.append('status', status);
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Добавляем здания в FormData
        for (let i = 0; i < buildings.length; i++) {
            formData.append('buildings[]', buildings[i]);
        }

        // Добавляем разделы в FormData
        for (let i = 0; i < sections.length; i++) {
            formData.append('sections[]', sections[i]);
        }
        console.log(sections);

        if (!currentProjectId) {
            // Создание нового проекта
            $.ajax({
                url: '/projects/create/',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    location.reload(); // Обновляем страницу после создания
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        } else {
            // Редактирование проекта
            $.ajax({
                url: `/projects/${currentProjectId}/edit/`,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    location.reload(); // Обновляем страницу после редактирования
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        }
    });

    // Обработчик добавления нового здания
    $('#addBuildingBtn').on('click', function () {
        const buildingTitle = $('#buildingTitleInput').val();
        if (!buildingTitle) {
            alert('Пожалуйста, введите название здания');
            return;
        }

        $('#buildingList').append(
            `<li class="list-group-item">${buildingTitle} 
            <button class="btn btn-danger btn-sm delete-building-btn">Удалить</button></li>`
        );
        $('#buildingTitleInput').val('');
    });

    // Обработчик удаления проекта
    $(document).on('click', '.delete-project-btn', function () {
        const projectId = $(this).data('id');
        if (confirm('Вы уверены, что хотите удалить этот проект?')) {
            $.ajax({
                url: `/projects/${projectId}/delete/`,
                method: 'POST',
                data: {
                    csrfmiddlewaretoken: csrfToken
                },
                success: function () {
                    location.reload();
                }
            });
        }
    });

    // Обработчик удаления здания
    $(document).on('click', '.delete-building-btn', function () {
        $(this).closest('li').remove();
    });
</script>
{% endblock %}
