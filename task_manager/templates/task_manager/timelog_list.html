{% extends 'task_manager/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <form method="get" action="" class="form-inline add-users-form">
            <div class="logs-form-wrapper">
                <div class="logs-form-input-wrapper">
                    <div class="datepicker-wrapper">
                        <input type="text" name="start_date" value="{{ start_date }}" class="date-input" data-cid="calendar" placeholder="Дата начала" />
                    </div>
                    <span>—</span>
                    <div class="datepicker-wrapper">
                        <input type="text" name="end_date" value="{{ end_date }}" class="date-input" data-cid="calendar" placeholder="Дата окончания" />
                    </div>
                </div>
                <div class="select" data-cid="select-for-calendar">
                    <span class="select__current">Период</span>
                    <div class="select__body">
                        <div class="select__item">Неделя</div>
                        <div class="select__item">Месяц</div>
                        <div class="select__item">3 месяца</div>
                        <div class="select__item">Пол года</div>
                        <div class="select__item">Год</div>
                    </div>
                </div>
                <button class="accept-btn" type="submit">Применить</button>
                <!-- Кнопка для создания нового таймлога -->
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#timelogModal">Добавить таймлог</button>
            </div>
        </form>
        <div class="table-wrapper only-bottom">
            <div id="logsTable" class="table table-striped">
                <div class="table__header">
                    <div class="table__row">
                        <div class="table__item" style="width: 133px">
                            <button class="sorter" data-cid="employees">
                                <p>Сотрудник</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 115px">
                            <button class="sorter" data-cid="department">
                                <p>Отдел</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 93px">
                            <button class="sorter"> 
                                <p>Дата</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 174px">
                            <button class="sorter" data-cid="project">
                                <p>Объект</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 93px">
                            <button class="sorter" data-cid="stage">
                                <p>Стадия</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 94px">
                            <button class="sorter" data-cid="section">
                                <p>Раздел</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 243px">
                            <button class="sorter" data-cid="zis">
                                <p>ЗИС</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 84px">
                            <button class="sorter" data-cid="mark">
                                <p>Марка</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 153px">
                            <button class="sorter" data-cid="tasks"> 
                                <p>Задача</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </div>
                        <div class="table__item" style="width: 89px">
                            <p>Время</p>
                        </div>
                    </div>
                </div>
                <div class="table__body" id="logsTableBody"></div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания нового таймлога -->
<div class="modal fade" id="timelogModal" tabindex="-1" aria-labelledby="timelogModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="timelogForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="timelogModalLabel">Создать таймлог</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Добавляем поля формы здесь -->
                    {{ form.as_p }} 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Обработчик отправки формы
    $('#timelogForm').on('submit', function (event) {
        event.preventDefault();
        const form = $(this);

        $.ajax({
            url: "{% url 'timelog-create' %}",
            method: 'POST',
            data: form.serialize(),
            success: function (data) {
                location.reload(); // Обновляем страницу после успешного создания
            },
            error: function (xhr, status, error) {
                console.error('Ошибка:', error);
            }
        });
    });


    const logs = [
        {% for log in timelogs %}
        {
            name: "{{ log.user.last_name }} {{ log.user.first_name }} {{ log.user.middle_name }}",
            department: "{{ log.department.title }}",
            date: "{{ log.date|date:'Y-m-d' }}",
            project: "{{ log.project }}",
            stage: "{{ log.stage }}",
            section: "{{ log.section.title }}",
            building: "{{ log.building.title }}",
            mark: "{{ log.mark.title }}",
            task: "{{ log.task.title }}",
            time: "{{ log.time }}"
        },
        {% endfor %}
    ];

    logs.sort((a, b) =>  new Date(b.date) - new Date(a.date));


    function displayUsers(logsToShow) {
        const tableBody = document.querySelector('#logsTableBody');
        tableBody.innerHTML = '';

        logsToShow.forEach(logs => {
            if(logs.stage === 'RD') {
                const row = `
                    <div class="table__row">
                        <div class="table__item" style="width: 133px">${logs.name}</div>
                        <div class="table__item" style="width: 115px">${logs.department}</div>
                        <div class="table__item" style="width: 93x">${logs.date}</div>
                        <div class="table__item" style="width: 174px">${logs.project}</div>
                        <div class="table__item" style="width: 93px">РД</div> 
                        <div class="table__item" style="width: 94px">${logs.section}</div>
                        <div class="table__item" style="width: 243px">${logs.building}</div>
                        <div class="table__item" style="width: 84px">${logs.mark}</div>
                        <div class="table__item" style="width: 153px">${logs.task}</div>
                        <div class="table__item" style="width: 89px">${logs.time} часов</div>
                    </div>
                `;
                tableBody.innerHTML += row;
            } else if (logs.stage === 'OTR') {
                const row = `
                    <div class="table__row">
                         <div class="table__item" style="width: 133px">${logs.name}</div>
                        <div class="table__item" style="width: 115px">${logs.department}</div>
                        <div class="table__item" style="width: 93x">${logs.date}</div>
                        <div class="table__item" style="width: 174px">${logs.project}</div>
                        <div class="table__item" style="width: 93px">ОТР</div> 
                        <div class="table__item" style="width: 94px">${logs.section}</div>
                        <div class="table__item" style="width: 243px">${logs.building}</div>
                        <div class="table__item" style="width: 84px">${logs.mark}</div>
                        <div class="table__item" style="width: 153px">${logs.task}</div>
                        <div class="table__item" style="width: 89px">${logs.time} часов</div>
                    </div>
                `;
                tableBody.innerHTML += row;
            } else if (logs.stage === 'PD') {
                const row = `
                    <div class="table__row">
                         <div class="table__item" style="width: 133px">${logs.name}</div>
                        <div class="table__item" style="width: 115px">${logs.department}</div>
                        <div class="table__item" style="width: 93x">${logs.date}</div>
                        <div class="table__item" style="width: 174px">${logs.project}</div>
                        <div class="table__item" style="width: 93px">ПД</div> 
                        <div class="table__item" style="width: 94px">${logs.section}</div>
                        <div class="table__item" style="width: 243px">${logs.building}</div>
                        <div class="table__item" style="width: 84px">${logs.mark}</div>
                        <div class="table__item" style="width: 153px">${logs.task}</div>
                        <div class="table__item" style="width: 89px">${logs.time} часов</div>
                    </div>
                `;
                tableBody.innerHTML += row;
            }
        });
    }

    displayUsers(logs);

</script>
{% endblock %}
