{% extends 'task_manager/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <form method="get" action="" class="form-inline add-users-form">
            <div class="logs-form-wrapper">
                <div class="logs-form-input-wrapper">
                    <div class="datepicker-wrapper">
                        <input type="text" name="start_date" value="{{ start_date }}" class="date-input" data-cid="calendar" placeholder="Дата начала" />
                    </div>
                    <span>—</span>
                    <div class="datepicker-wrapper">
                        <input type="text" name="end_date" value="{{ end_date }}" class="date-input" data-cid="calendar" placeholder="Дата окончания" />
                    </div>
                </div>
                <div class="select" data-cid="select-for-calendar">
                    <span class="select__current">Период</span>
                    <div class="select__body">
                        <div class="select__item">Неделя</div>
                        <div class="select__item">Месяц</div>
                        <div class="select__item">3 месяца</div>
                        <div class="select__item">Пол года</div>
                        <div class="select__item">Год</div>
                    </div>
                </div>
                <button class="accept-btn" type="submit">Применить</button>
                <!-- Кнопка для создания нового таймлога -->
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#timelogModal">Добавить таймлог</button>
            </div>
        </form>
        <div class="table-wrapper only-bottom">
            <table id="logsTable" class="table table-striped">
                <thead>
                    <tr>
                        <th style="width: 110px">
                            <button class="sorter" data-cid="employees">
                                <p>Сотрудник</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th >
                            <button class="sorter" data-cid="department">
                                <p>Отдел</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th >
                            <button class="sorter"> 
                                <p>Дата</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 153px">
                            <button class="sorter" data-cid="project">
                                <p>Объект</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th >
                            <button class="sorter" data-cid="stage">
                                <p>Стадия</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th >
                            <button class="sorter" data-cid="section">
                                <p>Раздел</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 223px">
                            <button class="sorter" data-cid="zis">
                                <p>ЗИС</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th >
                            <button class="sorter" data-cid="mark">
                                <p>Марка</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th >
                            <button class="sorter" data-cid="task"> 
                                <p>Задача</p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M4 8H12M2 4H14M6 12H10" stroke="#A6A6A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            </button>
                        </th>
                        <th style="width: 88px">
                            <p>Время</p>
                        </th>
                    </tr>
                </thead>
                <tbody id="logsTableBody"></tbody>
            </table>
        </div>
    
        <div class="pagination" id="pagination">
            <p id="pageInfo" class="page-info"></p>
            <div class="pagination-btn-wrapper">
                <button id="prevPage" class="pagination-button">Назад</button>
                <button id="nextPage" class="pagination-button">Вперед</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания нового таймлога -->
<div class="modal fade" id="timelogModal" tabindex="-1" aria-labelledby="timelogModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="timelogForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="timelogModalLabel">Создать таймлог</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Добавляем поля формы здесь -->
                    {{ form.as_p }} 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Обработчик отправки формы
    $('#timelogForm').on('submit', function (event) {
        event.preventDefault();
        const form = $(this);

        $.ajax({
            url: "{% url 'timelog-create' %}",
            method: 'POST',
            data: form.serialize(),
            success: function (data) {
                location.reload(); // Обновляем страницу после успешного создания
            },
            error: function (xhr, status, error) {
                console.error('Ошибка:', error);
            }
        });
    });


    const logs = [
        {% for log in timelogs %}
        {
            name: "{{ log.user.last_name }} {{ log.user.first_name }} {{ log.user.middle_name }}",
            department: "{{ log.department.title }}",
            date: "{{ log.date|date:'Y-m-d' }}",
            project: "{{ log.project }}",
            stage: "{{ log.stage }}",
            section: "{{ log.section.title }}",
            building: "{{ log.building.title }}",
            mark: "{{ log.mark.title }}",
            task: "{{ log.task.title }}",
            time: "{{ log.time }}"
        },
        {% endfor %}
    ];

    logs.sort((a, b) =>  new Date(b.date) - new Date(a.date));

    let currentPage = 1;
    const rowsPerPage = 5;

    function displayUsers(logsToShow) {
        const tableBody = document.querySelector('#logsTableBody');
        tableBody.innerHTML = '';

        logsToShow.forEach(logs => {
            // switch (logs.stage){
            //     case 'RD':
            //         logs.stage = 'РД';
            //     case 'OTR':
            //         logs.stage = 'ОТР';
            //     case 'PD':
            //         logs.stage = 'ПД';
            // }

            if(logs.stage === 'RD') {
                const row = `
                    <tr>
                        <td>${logs.name}</td>
                        <td>${logs.department}</td>
                        <td>${logs.date}</td>
                        <td>${logs.project}</td>
                        <td>РД</td> 
                        <td>${logs.section}</td>
                        <td>${logs.building}</td>
                        <td>${logs.mark}</td>
                        <td>${logs.task}</td>
                        <td>${logs.time} часов</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            } else if (logs.stage === 'OTR') {
                const row = `
                    <tr>
                        <td>${logs.name}</td>
                        <td>${logs.department}</td>
                        <td>${logs.date}</td>
                        <td>${logs.project}</td>
                        <td>ОТР</td> 
                        <td>${logs.section}</td>
                        <td>${logs.building}</td>
                        <td>${logs.mark}</td>
                        <td>${logs.task}</td>
                        <td>${logs.time} часов</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            } else if (logs.stage === 'PD') {
                const row = `
                    <tr>
                        <td>${logs.name}</td>
                        <td>${logs.department}</td>
                        <td>${logs.date}</td>
                        <td>${logs.project}</td>
                        <td>ПД</td> 
                        <td>${logs.section}</td>
                        <td>${logs.building}</td>
                        <td>${logs.mark}</td>
                        <td>${logs.task}</td>
                        <td>${logs.time} часов</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        });
    }

    function updatePageInfo(totalPages) {
        const pageInfo = document.getElementById('pageInfo');
        pageInfo.innerText = `Страница ${currentPage} / ${totalPages}`;
    }

    function setupPagination(logs) {
        const totalPages = Math.ceil(logs.length / rowsPerPage);

        if(totalPages <= 1) {
            document.querySelector('#pagination').style.display = 'none';
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayPage(logs, totalPages);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                displayPage(logs, totalPages);
            }
        });

        displayPage(logs, totalPages);
    }

    function displayPage(logs, totalPages) {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const logsToShow = logs.slice(start, end);
        displayUsers(logsToShow);
        updatePageInfo(totalPages);
    }

    setupPagination(logs);

</script>
{% endblock %}
